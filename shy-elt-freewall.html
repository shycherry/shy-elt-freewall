<link rel="import" href="../polymer/polymer.html">
<script type="text/javascript" src="../underscore/underscore.js"></script>

<!-- emits "relayout" -->
<polymer-element name="shy-elt-freewall" attributes="delay transitionDuration withRelayoutingClass">
  <template>
    <style type="text/css">
      :host {
        display: block !important;
        position: relative !important;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      :host > *{
        position: absolute !important;
        overflow: auto;
      }
      :host > .relayouting{
        -webkit-transition: opacity 0s;
        opacity: 0.5;
      }
    </style>
    <content id="content"></content>
  </template>
  <script>
    Polymer('shy-elt-freewall',{
      items : [],
      transitionDuration : 0,
      delay : 0,
      withRelayoutingClass : false,
      ready : function(){
        
        this.startRelayout = this.startRelayout.bind(this);
        
        if(this.transitionDuration)
          this.endRelayout = _.debounce(this.endRelayout, this.transitionDuration).bind(this);
        else
          this.endRelayout = this.endRelayout.bind(this);
        
        if(this.delay)
          this.startRelayout = _.debounce(this.startRelayout, this.delay).bind(this);
        else
          this.startRelayout = this.startRelayout.bind(this);

        this.onMutation(this, this.childrenUpdated);
      },
      attached : function(){
        window.addEventListener('resize', this.startRelayout)
      },
      detached : function(){
        window.removeEventListener('resize', this.startRelayout);
      },
      domReady : function(){
        this.startRelayout();
      },
      childrenUpdated : function(observer, mutations){
        this.startRelayout();
        this.onMutation(this, this.childrenUpdated);
      },
      endRelayout : function(){
        console.log('endRelayout');
        if(!this.items)
          return;

        for(var iElt = 0; iElt<this.items.length; iElt++){
          var currentElt = this.items[iElt];
          
          if(this.withRelayoutingClass)
            currentElt.classList.remove('relayouting');
        }
        
        this.fire('relayout');
        var self = this;
        setTimeout(function(){self.fire('relayoutBis')},this.transitionDuration);
      },
      startRelayout : function(){
        console.log('relayouting ');
        this.items = _.filter(this.$.content.getDistributedNodes(), function(item){return item.style;});

        if(!this.items)
          return;

        var totalWidth = this.clientWidth;
        var totalHeight = this.clientHeight;
        var eltWidth = totalWidth;
        var eltHeight = totalHeight;
        var nbElts = this.items.length;
        var nbRows = 1;
        var nbCols = 1;

        while( (nbRows*nbCols)<nbElts ){
          if( ((nbCols+1) * nbRows > nbElts) && (nbCols+1)%nbElts != 0 ){
            nbRows++;
          }else if (((nbRows+1) * nbCols > nbElts) && (nbRows+1)%nbElts != 0 ){
            nbCols++;
          }else if(eltWidth >= eltHeight){            
            nbCols++;
            // eltWidth = totalWidth / nbCols;
          }else{
            nbRows++;
            // eltHeight = totalHeight / nbRows;
          }
          eltWidth = totalWidth / nbCols;
          eltHeight = totalHeight / nbRows;
        }

        var currentRow = 0;
        var currentCol = 0;
        for(var iElt = 0; iElt<nbElts; iElt++){
          var currentElt = this.items[iElt];

          if(this.withRelayoutingClass)
            currentElt.classList.add('relayouting');
          
          currentElt.style.webkitTransition = this.transitionDuration +'ms' || '0';
          currentElt.style.left = (currentCol * eltWidth) + 'px';
          currentElt.style.top = (currentRow * eltHeight) + 'px';
          
          if( (iElt+1 == nbElts) ){
            nbEltsMissing = (nbRows*nbCols) - nbElts ;
            currentElt.style.width = ((1+nbEltsMissing)*eltWidth)+'px';
          }else{
            currentElt.style.width = eltWidth+'px';
          }          
          currentElt.style.height = eltHeight+'px';

          currentCol = (currentCol+1)%nbCols;
          if(currentCol == 0)
            currentRow = (currentRow+1)%nbRows;
        }

        this.endRelayout();
      }
    });
  </script>
</polymer-element>