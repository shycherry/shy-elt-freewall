<link rel="import" href="../polymer/polymer.html">
<script type="text/javascript" src="../freewall/index.js"></script>
<script type="text/javascript" src="../jquery/index.js"></script>
<script type="text/javascript" src="../underscore/underscore.js"></script>

<polymer-element name="shy-elt-freewall">
  <template>
    <style type="text/css">
      :host {
        position: relative;
      }
      :host > *{
        opacity: 0;
      }
    </style>
    <content id="content"></content>
  </template>
  <script>
    Polymer('shy-elt-freewall',{
      items : [],
      ready : function(){
        this.lazyRelayout = _.debounce(this.relayout, 100).bind(this);
        this.onMutation(this, this.childrenUpdated);
      },
      domReady : function(){
        this.relayout();
      },
      childrenUpdated : function(observer, mutations){
        this.lazyRelayout();
        // this.relayout();
        this.onMutation(this, this.childrenUpdated);
      },      
      relayout : function(){
        console.log('relayouting');
        this.items = this.$.content.getDistributedNodes().filter(function(item){return item.style;});

        var totalWidth = this.parentElement.clientWidth;
        var totalHeight = this.parentElement.clientHeight;
        var eltWidth = totalWidth;
        var eltHeight = totalHeight;
        var nbElts = this.items.length;
        var nbRows = 1;
        var nbCols = 1;

        while( (nbRows*nbCols)<nbElts ){
          if(eltWidth >= eltHeight){
            nbCols++;
            eltWidth = totalWidth / nbCols;
          }else{
            nbRows++;
            eltHeight = totalHeight / nbRows;
          }
        }

        var currentRow = 0;
        var currentCol = 0;
        for(var iElt = 0; iElt<nbElts; iElt++){
          var currentElt = this.items[iElt];
          currentElt.style.position = 'absolute';
          currentElt.style.webkitTransitionProperty = 'opacity';
          currentElt.style.webkitTransitionDuration = '0.1s';
          currentElt.style.left = (currentCol * eltWidth) + 'px';
          currentElt.style.top = (currentRow * eltHeight) + 'px';
          currentElt.style.width = eltWidth+'px';
          currentElt.style.height = eltHeight+'px';
          currentElt.style.overflow = 'auto';
          currentElt.style.opacity = 1;

          currentCol = (currentCol+1)%nbCols;
          if(currentCol == 0)
            currentRow = (currentRow+1)%nbRows;
        }

      }
    });
  </script>
</polymer-element>