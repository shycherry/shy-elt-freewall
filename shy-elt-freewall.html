<link rel="import" href="../polymer/polymer.html">
<!-- <script type="text/javascript" src="../jquery/index.js"></script> -->
<script type="text/javascript" src="../underscore/underscore.js"></script>

<polymer-element name="shy-elt-freewall" attributes="transitionDuration">
  <template>
    <style type="text/css">
      :host {
        display: block !important;
        position: relative !important;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      :host > *{
        -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
        position: absolute !important;
        overflow: auto;
      }
      :host > .relayouting{
        -webkit-transition: opacity 0s;
        opacity: 0.5;
      }
    </style>
    <content id="content"></content>
  </template>
  <script>
    Polymer('shy-elt-freewall',{
      items : [],
      ready : function(){
        this.startRelayout = this.startRelayout.bind(this);
        this.endRelayout = this.endRelayout.bind(this);
        this.lazyEndRelayout = _.debounce(this.endRelayout, this.transitionDuration);
        this.onMutation(this, this.childrenUpdated);
      },
      attached : function(){
        window.addEventListener('resize', this.startRelayout);
      },
      detached : function(){
        window.removeEventListener('resize', this.startRelayout);
      },
      domReady : function(){
        this.startRelayout();
      },
      childrenUpdated : function(observer, mutations){
        this.startRelayout();
        this.onMutation(this, this.childrenUpdated);
      },
      endRelayout : function(){
        for(var iElt = 0; iElt<this.items.length; iElt++){
          var currentElt = this.items[iElt];
          currentElt.classList.remove('relayouting');
        }
      },
      startRelayout : function(){
        console.log('relayouting ');
        this.items = this.$.content.getDistributedNodes().filter(function(item){return item.style;});

        var totalWidth = this.clientWidth;
        var totalHeight = this.clientHeight;
        var eltWidth = totalWidth;
        var eltHeight = totalHeight;
        var nbElts = this.items.length;
        var nbRows = 1;
        var nbCols = 1;

        while( (nbRows*nbCols)<nbElts ){
          if( ((nbCols+1) * nbRows > nbElts) && (nbCols+1)%nbElts != 0 ){
            nbRows++;
          }else if (((nbRows+1) * nbCols > nbElts) && (nbRows+1)%nbElts != 0 ){
            nbCols++;
          }else if(eltWidth >= eltHeight){            
            nbCols++;
            // eltWidth = totalWidth / nbCols;
          }else{
            nbRows++;
            // eltHeight = totalHeight / nbRows;
          }
          eltWidth = totalWidth / nbCols;
          eltHeight = totalHeight / nbRows;
        }

        var currentRow = 0;
        var currentCol = 0;
        for(var iElt = 0; iElt<nbElts; iElt++){
          var currentElt = this.items[iElt];

          currentElt.classList.add('relayouting');
          currentElt.style.webkitTransition = this.transitionDuration +'ms' || '0';
          currentElt.style.left = (currentCol * eltWidth) + 'px';
          currentElt.style.top = (currentRow * eltHeight) + 'px';
          
          if( (iElt+1 == nbElts) ){
            nbEltsMissing = (nbRows*nbCols) - nbElts ;
            currentElt.style.width = ((1+nbEltsMissing)*eltWidth)+'px';
          }else{
            currentElt.style.width = eltWidth+'px';
          }          
          currentElt.style.height = eltHeight+'px';

          currentCol = (currentCol+1)%nbCols;
          if(currentCol == 0)
            currentRow = (currentRow+1)%nbRows;
        }

        this.lazyEndRelayout();

      }
    });
  </script>
</polymer-element>